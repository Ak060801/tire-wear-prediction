#!/usr/bin/env python3
import numpy as np
import os
import joblib
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, log_loss
import xgboost as xgb
import tensorflow as tf
from tensorflow.keras import layers, models, optimizers, losses, callbacks

def build_xgb(X_train, y_train, seed=42):
    dtrain = xgb.DMatrix(X_train, label=y_train)
    params = {
        'objective': 'binary:logistic',
        'eval_metric': 'logloss',
        'eta': 0.05,
        'max_depth': 6,
        'subsample': 0.8,
        'seed': seed,
        'verbosity': 0
    }
    num_round = 200
    model = xgb.train(params, dtrain, num_boost_round=num_round)
    return model

def build_lstm(seq_data, labels, seq_len=50, sensors=6, seed=42, epochs=8, batch_size=64):
    # seq_data shape: (n_samples, seq_len, sensors)
    tf.random.set_seed(seed)
    inp = layers.Input(shape=(seq_len, sensors))
    x = layers.Masking()(inp)
    x = layers.Bidirectional(layers.LSTM(64, return_sequences=True))(x)
    x = layers.Bidirectional(layers.LSTM(32))(x)
    x = layers.Dense(32, activation='relu')(x)
    out = layers.Dense(1, activation='sigmoid')(x)
    model = models.Model(inp, out)
    model.compile(optimizer=optimizers.Adam(learning_rate=1e-3), loss='binary_crossentropy', metrics=['accuracy'])
    es = callbacks.EarlyStopping(monitor='val_accuracy', patience=3, restore_best_weights=True, verbose=0)

    Xtr, Xval, ytr, yval = train_test_split(seq_data, labels, test_size=0.15, random_state=seed, stratify=labels)
    model.fit(Xtr, ytr, validation_data=(Xval, yval), epochs=epochs, batch_size=batch_size, callbacks=[es], verbose=0)
    return model

def eval_model_binary(model, X, y, model_type='xgb', seq_data_for_lstm=None):
    if model_type == 'xgb':
        d = xgb.DMatrix(X)
        p = model.predict(d)
    elif model_type == 'lstm':
        p = model.predict(seq_data_for_lstm, verbose=0).flatten()
    else:
        raise ValueError("model_type must be 'xgb' or 'lstm'")
    preds = (p >= 0.5).astype(int)
    acc = accuracy_score(y, preds)
    return acc, p

def save_xgb(model, path):
    model.save_model(path)

def load_xgb(path):
    m = xgb.Booster()
    m.load_model(path)
    return m

def save_keras(model, path):
    model.save(path)

def load_keras(path):
    return tf.keras.models.load_model(path)
